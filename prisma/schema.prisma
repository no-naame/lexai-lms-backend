generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  PLATFORM_ADMIN
  INSTITUTION_ADMIN
  INSTRUCTOR
  STUDENT
}

enum OrgMemberRole {
  ADMIN
  STUDENT
}

enum AccessSource {
  INDIVIDUAL
  INSTITUTION
}

enum LessonType {
  VIDEO
  ARTICLE
}

// ─── Core Tables ──────────────────────────────────────────────

model User {
  id             String    @id @default(cuid())
  name           String
  email          String    @unique
  emailVerified  DateTime?
  image          String?
  hashedPassword String?
  role           Role      @default(STUDENT)
  isActive       Boolean   @default(true)
  isPremium      Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  oauthAccounts       OAuthAccount[]
  refreshTokens       RefreshToken[]
  organizationMembers OrganizationMember[]
  courseEnrollments    CourseEnrollment[]
  claimedRecords      StudentRecord[]      @relation("ClaimedBy")
  passwordResetTokens PasswordResetToken[]
  lessonProgress      UserLessonProgress[]
  payments            Payment[]

  @@map("users")
}

model OAuthAccount {
  id                String  @id @default(cuid())
  userId            String
  provider          String
  providerAccountId String
  accessToken       String?
  refreshToken      String?
  expiresAt         Int?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("oauth_accounts")
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// ─── Institutional Tables ─────────────────────────────────────

model Organization {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  emailDomains  String[]
  isActive      Boolean  @default(true)
  contractStart DateTime?
  contractEnd   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  members       OrganizationMember[]
  batches       Batch[]
  studentRecords StudentRecord[]
  courseAccess   OrganizationCourseAccess[]

  @@map("organizations")
}

model OrganizationMember {
  id             String        @id @default(cuid())
  userId         String
  organizationId String
  role           OrgMemberRole @default(STUDENT)
  enrollmentId   String?
  batchId        String?
  isVerified     Boolean       @default(false)
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  batch        Batch?       @relation(fields: [batchId], references: [id])

  @@unique([userId, organizationId])
  @@unique([organizationId, enrollmentId])
  @@map("organization_members")
}

model Batch {
  id             String  @id @default(cuid())
  organizationId String
  name           String
  isActive       Boolean @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members      OrganizationMember[]
  studentRecords StudentRecord[]
  courseAccess  BatchCourseAccess[]

  @@unique([organizationId, name])
  @@map("batches")
}

model StudentRecord {
  id             String  @id @default(cuid())
  organizationId String
  email          String
  name           String?
  enrollmentId   String
  batchId        String?
  isClaimed      Boolean @default(false)
  claimedByUserId String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  batch        Batch?       @relation(fields: [batchId], references: [id])
  claimedBy    User?        @relation("ClaimedBy", fields: [claimedByUserId], references: [id])

  @@unique([organizationId, email])
  @@unique([organizationId, enrollmentId])
  @@map("student_records")
}

// ─── Course Access Tables ─────────────────────────────────────

model Course {
  id               String    @id @default(cuid())
  title            String
  slug             String    @unique
  description      String?
  shortDescription String?   @db.VarChar(150)
  longDescription  String?   @db.Text
  thumbnail        String?
  introVideoUrl    String?
  isPublished      Boolean   @default(false)
  price            Float     @default(0)
  category         String    @default("engineering")
  level            String    @default("Beginner")
  tags             String[]  @default([])
  studentsCount    Int       @default(0)
  rating           Float     @default(0)
  reviewsCount     Int       @default(0)
  includes         Json?
  whatYouWillLearn Json?
  prerequisites    Json?
  isFeatured       Boolean   @default(false)
  publishedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  enrollments     CourseEnrollment[]
  orgAccess       OrganizationCourseAccess[]
  batchAccess     BatchCourseAccess[]
  modules         Module[]

  @@map("courses")
}

model CourseEnrollment {
  id                 String       @id @default(cuid())
  userId             String
  courseId            String
  accessSource       AccessSource @default(INDIVIDUAL)
  status             String       @default("not-started")
  progressPercentage Int          @default(0)
  currentLessonId    String?
  lastAccessedAt     DateTime?
  createdAt          DateTime     @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("course_enrollments")
}

model OrganizationCourseAccess {
  id             String @id @default(cuid())
  organizationId String
  courseId        String
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  course       Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([organizationId, courseId])
  @@map("organization_course_access")
}

model BatchCourseAccess {
  id        String @id @default(cuid())
  batchId   String
  courseId   String
  createdAt DateTime @default(now())

  batch  Batch  @relation(fields: [batchId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([batchId, courseId])
  @@map("batch_course_access")
}

// ─── Course Content Tables ────────────────────────────────────

model Module {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  description String?
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@unique([courseId, order])
  @@map("modules")
}

model Lesson {
  id          String     @id @default(cuid())
  moduleId    String
  title       String
  description String?
  order       Int
  type        LessonType @default(ARTICLE)
  isFree      Boolean    @default(false)
  isPreview   Boolean    @default(false)
  videoUrl    String?
  content     String?    @db.Text
  duration    Int        @default(0)
  notes       String?    @db.Text
  resources   Json?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  module   Module               @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress UserLessonProgress[]

  @@unique([moduleId, order])
  @@map("lessons")
}

model UserLessonProgress {
  id             String    @id @default(cuid())
  userId         String
  lessonId       String
  completed      Boolean   @default(false)
  completedAt    DateTime?
  watchedSeconds Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("user_lesson_progress")
}

// ─── Video Asset Tables ──────────────────────────────────────

model VideoAsset {
  id               String   @id @default(cuid())
  gumletAssetId    String   @unique
  status           String   @default("pending")   // pending | uploading | processing | ready | errored
  playbackUrl      String?
  thumbnailUrl     String?
  duration         Int?                            // seconds, set by webhook
  targetType       String                          // "course_intro" | "lesson"
  targetId         String                          // Course.id or Lesson.id
  originalFilename String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([targetType, targetId])
  @@map("video_assets")
}

// ─── Auth Support Tables ──────────────────────────────────────

model EmailVerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("email_verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

// ─── Payment Tables ──────────────────────────────────────────

model Payment {
  id                String   @id @default(cuid())
  userId            String
  razorpayOrderId   String   @unique
  razorpayPaymentId String?  @unique
  amount            Int                              // in paise (e.g. 49900 = ₹499)
  currency          String   @default("INR")
  status            String   @default("created")     // created | paid | failed
  receipt           String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("payments")
}
